<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TMS</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="dashboard">
        <header class="dashboard-header">
            <div class="dashboard-nav">
                <h1>Admin Dashboard</h1>
                <div class="dashboard-actions">
                    <span id="welcomeText" class="welcome-text"></span>
                    <button id="logoutBtn" class="btn btn--outline">Logout</button>
                </div>
            </div>
        </header>

        <main class="dashboard-main">
            <div class="dashboard-content">
                <div class="dashboard-tabs">
                    <button class="tab-btn active" data-tab="tickets">Tickets</button>
                    <button class="tab-btn" data-tab="users">Users</button>
                </div>

                <!-- Tickets Tab -->
                <div id="ticketsTab" class="tab-content active">
                    <div class="dashboard-stats">
                        <div class="stat-card">
                            <h3>Total Tickets</h3>
                            <p class="stat-number" id="totalTickets">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Pending</h3>
                            <p class="stat-number" id="pendingTickets">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Assigned</h3>
                            <p class="stat-number" id="assignedTickets">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Resolved</h3>
                            <p class="stat-number" id="resolvedTickets">0</p>
                        </div>
                    </div>

                    <div class="dashboard-section">
                        <div class="section-header">
                            <h2>All Tickets</h2>
                            <div class="section-controls">
                                <input type="text" id="searchTickets" placeholder="Search tickets..." class="search-input">
                                <select id="filterStatus" class="filter-select">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="assigned">Assigned</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="resolved">Resolved</option>
                                </select>
                            </div>
                        </div>
                        <div id="ticketsList" class="tickets-table-container">
                            <table class="tickets-table">
                                <thead>
                                    <tr>
                                        <th>Ticket ID</th>
                                        <th>Subject</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Created By</th>
                                        <th>Assigned To</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ticketsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="usersTab" class="tab-content">
                    <div class="dashboard-section">
                        <div class="section-header">
                            <h2>User Management</h2>
                            <button id="addUserBtn" class="btn btn--primary">Add User</button>
                        </div>
                        <div id="usersList" class="users-table-container">
                            <table class="users-table">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Assign Ticket Modal -->
    <div id="assignTicketModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Assign Ticket</h3>
                <button class="modal-close" id="closeAssignModal">&times;</button>
            </div>
            <form id="assignTicketForm" class="modal-form">
                <input type="hidden" id="assignTicketId">
                <div class="form-group">
                    <label for="assignAgent" class="form-label">Select Agent</label>
                    <select id="assignAgent" name="agent" class="form-select" required>
                        <option value="">Select an agent</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn--outline" id="cancelAssignBtn">Cancel</button>
                    <button type="submit" class="btn btn--primary">Assign Ticket</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Add User</h3>
                <button class="modal-close" id="closeUserModal">&times;</button>
            </div>
            <form id="userForm" class="modal-form">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label for="userEmail" class="form-label">Email</label>
                    <input type="email" id="userEmail" name="email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="userUsername" class="form-label">Username</label>
                    <input type="text" id="userUsername" name="username" class="form-input" required>
                </div>
                <div class="form-group" id="passwordGroup">
                    <label for="userPassword" class="form-label">Password</label>
                    <input type="password" id="userPassword" name="password" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="userRole" class="form-label">Role</label>
                    <select id="userRole" name="role" class="form-select" required>
                        <option value="">Select role</option>
                        <option value="customer">Customer</option>
                        <option value="agent">Agent</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn--outline" id="cancelUserBtn">Cancel</button>
                    <button type="submit" class="btn btn--primary" id="saveUserBtn">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast" style="display: none;">
        <span id="toastMessage"></span>
    </div>

    <script src="js/storageService.js"></script>
    <script src="js/authService.js"></script>
    <script src="js/ticketService.js"></script>
    <script src="js/emailService.js"></script>
    <script src="js/uiService.js"></script>
    <script>
        let currentUser = null;
        let allTickets = [];
        let allUsers = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!authService.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = authService.getLoggedInUser();
            if (currentUser.role !== 'admin') {
                window.location.href = 'login.html';
                return;
            }

            // Initialize page
            initializePage();
            loadData();

            // Event listeners
            setupEventListeners();

            // Storage event listener for cross-tab sync
            window.addEventListener('storage', function(e) {
                if (e.key === 'tms_tickets' || e.key === 'tms_users') {
                    loadData();
                }
            });
        });

        function initializePage() {
            document.getElementById('welcomeText').textContent = `Welcome, ${currentUser.username}!`;
        }

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });

            // Main actions
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('addUserBtn').addEventListener('click', showAddUserModal);
            
            // Search and filter
            document.getElementById('searchTickets').addEventListener('input', filterTickets);
            document.getElementById('filterStatus').addEventListener('change', filterTickets);

            // Modal handlers
            document.getElementById('closeAssignModal').addEventListener('click', hideAssignModal);
            document.getElementById('cancelAssignBtn').addEventListener('click', hideAssignModal);
            document.getElementById('assignTicketForm').addEventListener('submit', assignTicket);

            document.getElementById('closeUserModal').addEventListener('click', hideUserModal);
            document.getElementById('cancelUserBtn').addEventListener('click', hideUserModal);
            document.getElementById('userForm').addEventListener('submit', saveUser);
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        function loadData() {
            allTickets = ticketService.getAllTickets();
            allUsers = storageService.getAllUsers().filter(u => u.role !== 'admin');
            
            loadTickets();
            loadUsers();
            updateStats();
            loadAgents();
        }

        function loadTickets() {
            const ticketsBody = document.getElementById('ticketsTableBody');
            
            if (allTickets.length === 0) {
                ticketsBody.innerHTML = '<tr><td colspan="7" class="empty-state">No tickets found</td></tr>';
                return;
            }

            ticketsBody.innerHTML = allTickets.map(ticket => {
                const creator = storageService.getUserById(ticket.createdBy);
                const assignee = ticket.assignedTo ? storageService.getUserById(ticket.assignedTo) : null;
                
                return `
                    <tr>
                        <td>${ticket.id}</td>
                        <td>${ticket.subject}</td>
                        <td><span class="priority priority--${ticket.priority.toLowerCase()}">${ticket.priority}</span></td>
                        <td><span class="status-badge status--${ticket.status}">${ticket.status}</span></td>
                        <td>${creator ? creator.username : 'Unknown'}</td>
                        <td>${assignee ? assignee.username : 'Unassigned'}</td>
                        <td>
                            ${ticket.status === 'pending' ? 
                                `<button class="btn btn--small btn--primary" onclick="showAssignModal('${ticket.id}')">Assign</button>` :
                                '<span class="text-muted">Assigned</span>'
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function loadUsers() {
            const usersBody = document.getElementById('usersTableBody');
            
            if (allUsers.length === 0) {
                usersBody.innerHTML = '<tr><td colspan="6" class="empty-state">No users found</td></tr>';
                return;
            }

            usersBody.innerHTML = allUsers.map(user => `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td><span class="role-badge role--${user.role}">${user.role}</span></td>
                    <td><span class="status-badge status--${user.isActive ? 'active' : 'inactive'}">${user.isActive ? 'Active' : 'Inactive'}</span></td>
                    <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn--small btn--outline" onclick="editUser('${user.id}')">Edit</button>
                        <button class="btn btn--small btn--danger" onclick="deleteUser('${user.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function loadAgents() {
            const agentSelect = document.getElementById('assignAgent');
            const agents = allUsers.filter(u => u.role === 'agent' && u.isActive);
            
            agentSelect.innerHTML = '<option value="">Select an agent</option>' + 
                agents.map(agent => `<option value="${agent.id}">${agent.username}</option>`).join('');
        }

        function updateStats() {
            document.getElementById('totalTickets').textContent = allTickets.length;
            document.getElementById('pendingTickets').textContent = allTickets.filter(t => t.status === 'pending').length;
            document.getElementById('assignedTickets').textContent = allTickets.filter(t => t.status === 'assigned' || t.status === 'in_progress').length;
            document.getElementById('resolvedTickets').textContent = allTickets.filter(t => t.status === 'resolved').length;
        }

        function filterTickets() {
            const searchTerm = document.getElementById('searchTickets').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            
            let filteredTickets = allTickets;
            
            if (searchTerm) {
                filteredTickets = filteredTickets.filter(ticket => 
                    ticket.id.toLowerCase().includes(searchTerm) ||
                    ticket.subject.toLowerCase().includes(searchTerm) ||
                    ticket.description.toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter) {
                filteredTickets = filteredTickets.filter(ticket => ticket.status === statusFilter);
            }
            
            // Update display with filtered results
            const ticketsBody = document.getElementById('ticketsTableBody');
            ticketsBody.innerHTML = filteredTickets.map(ticket => {
                const creator = storageService.getUserById(ticket.createdBy);
                const assignee = ticket.assignedTo ? storageService.getUserById(ticket.assignedTo) : null;
                
                return `
                    <tr>
                        <td>${ticket.id}</td>
                        <td>${ticket.subject}</td>
                        <td><span class="priority priority--${ticket.priority.toLowerCase()}">${ticket.priority}</span></td>
                        <td><span class="status-badge status--${ticket.status}">${ticket.status}</span></td>
                        <td>${creator ? creator.username : 'Unknown'}</td>
                        <td>${assignee ? assignee.username : 'Unassigned'}</td>
                        <td>
                            ${ticket.status === 'pending' ? 
                                `<button class="btn btn--small btn--primary" onclick="showAssignModal('${ticket.id}')">Assign</button>` :
                                '<span class="text-muted">Assigned</span>'
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showAssignModal(ticketId) {
            document.getElementById('assignTicketId').value = ticketId;
            document.getElementById('assignTicketModal').style.display = 'flex';
        }

        function hideAssignModal() {
            document.getElementById('assignTicketModal').style.display = 'none';
            document.getElementById('assignTicketForm').reset();
        }

        function assignTicket(e) {
            e.preventDefault();
            
            const ticketId = document.getElementById('assignTicketId').value;
            const agentId = document.getElementById('assignAgent').value;
            
            ticketService.assignTicket(ticketId, agentId);
            uiService.showToast('Ticket assigned successfully!', 'success');
            
            hideAssignModal();
            loadData();
        }

        function showAddUserModal() {
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('editUserId').value = '';
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('userPassword').required = true;
            document.getElementById('saveUserBtn').textContent = 'Add User';
            document.getElementById('userModal').style.display = 'flex';
        }

        function editUser(userId) {
            const user = storageService.getUserById(userId);
            if (!user) return;
            
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('editUserId').value = userId;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userRole').value = user.role;
            document.getElementById('passwordGroup').style.display = 'none';
            document.getElementById('userPassword').required = false;
            document.getElementById('saveUserBtn').textContent = 'Update User';
            document.getElementById('userModal').style.display = 'flex';
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                storageService.deleteUser(userId);
                uiService.showToast('User deleted successfully!', 'success');
                loadData();
            }
        }

        function hideUserModal() {
            document.getElementById('userModal').style.display = 'none';
            document.getElementById('userForm').reset();
        }

        function saveUser(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userId = document.getElementById('editUserId').value;
            
            const userData = {
                email: formData.get('email'),
                username: formData.get('username'),
                role: formData.get('role')
            };
            
            if (!userId) {
                // Adding new user
                userData.password = formData.get('password');
                userData.id = `user_${Date.now()}`;
                userData.createdAt = new Date().toISOString();
                userData.isActive = true;
                
                storageService.saveUser(userData);
                uiService.showToast('User added successfully!', 'success');
            } else {
                // Editing existing user
                const existingUser = storageService.getUserById(userId);
                const updatedUser = { ...existingUser, ...userData };
                storageService.saveUser(updatedUser);
                uiService.showToast('User updated successfully!', 'success');
            }
            
            hideUserModal();
            loadData();
        }

        function logout() {
            authService.logout();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>