<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Dashboard - TMS</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="dashboard">
        <header class="dashboard-header">
            <div class="dashboard-nav">
                <h1>Agent Dashboard</h1>
                <div class="dashboard-actions">
                    <span id="welcomeText" class="welcome-text"></span>
                    <button id="logoutBtn" class="btn btn--outline">Logout</button>
                </div>
            </div>
        </header>

        <main class="dashboard-main">
            <div class="dashboard-content">
                <div class="dashboard-tabs">
                    <button class="tab-btn active" data-tab="assigned">Assigned Tickets</button>
                    <button class="tab-btn" data-tab="pending">Pending Tickets</button>
                    <button class="tab-btn" data-tab="resolved">Resolved Tickets</button>
                </div>

                <div class="dashboard-stats">
                    <div class="stat-card">
                        <h3>Assigned to Me</h3>
                        <p class="stat-number" id="assignedCount">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>In Progress</h3>
                        <p class="stat-number" id="inProgressCount">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Resolved</h3>
                        <p class="stat-number" id="resolvedCount">0</p>
                    </div>
                </div>

                <!-- Assigned Tickets Tab -->
                <div id="assignedTab" class="tab-content active">
                    <div class="dashboard-section">
                        <h2>My Assigned Tickets</h2>
                        <div id="assignedTicketsList" class="tickets-list"></div>
                    </div>
                </div>

                <!-- Pending Tickets Tab -->
                <div id="pendingTab" class="tab-content">
                    <div class="dashboard-section">
                        <h2>All Pending Tickets</h2>
                        <div id="pendingTicketsList" class="tickets-list"></div>
                    </div>
                </div>

                <!-- Resolved Tickets Tab -->
                <div id="resolvedTab" class="tab-content">
                    <div class="dashboard-section">
                        <h2>My Resolved Tickets</h2>
                        <div id="resolvedTicketsList" class="tickets-list"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="toast" style="display: none;">
        <span id="toastMessage"></span>
    </div>

    <script src="js/storageService.js"></script>
    <script src="js/authService.js"></script>
    <script src="js/ticketService.js"></script>
    <script src="js/emailService.js"></script>
    <script src="js/uiService.js"></script>
    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!authService.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = authService.getLoggedInUser();
            if (currentUser.role !== 'agent') {
                window.location.href = 'login.html';
                return;
            }

            // Initialize page
            initializePage();
            loadData();

            // Event listeners
            setupEventListeners();

            // Storage event listener for cross-tab sync
            window.addEventListener('storage', function(e) {
                if (e.key === 'tms_tickets') {
                    loadData();
                }
            });
        });

        function initializePage() {
            document.getElementById('welcomeText').textContent = `Welcome, ${currentUser.username}!`;
        }

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        function loadData() {
            loadAssignedTickets();
            loadPendingTickets();
            loadResolvedTickets();
            updateStats();
        }

        function loadAssignedTickets() {
            const tickets = ticketService.getTicketsForUser(currentUser.id, 'agent');
            const assignedTickets = tickets.filter(t => t.status === 'assigned' || t.status === 'in_progress');
            const container = document.getElementById('assignedTicketsList');
            
            if (assignedTickets.length === 0) {
                container.innerHTML = '<p class="empty-state">No assigned tickets</p>';
                return;
            }

            container.innerHTML = assignedTickets.map(ticket => createTicketCard(ticket, true)).join('');
        }

        function loadPendingTickets() {
            const allTickets = ticketService.getAllTickets();
            const pendingTickets = allTickets.filter(t => t.status === 'pending');
            const container = document.getElementById('pendingTicketsList');
            
            if (pendingTickets.length === 0) {
                container.innerHTML = '<p class="empty-state">No pending tickets</p>';
                return;
            }

            container.innerHTML = pendingTickets.map(ticket => createTicketCard(ticket, false)).join('');
        }

        function loadResolvedTickets() {
            const tickets = ticketService.getTicketsForUser(currentUser.id, 'agent');
            const resolvedTickets = tickets.filter(t => t.status === 'resolved');
            const container = document.getElementById('resolvedTicketsList');
            
            if (resolvedTickets.length === 0) {
                container.innerHTML = '<p class="empty-state">No resolved tickets</p>';
                return;
            }

            container.innerHTML = resolvedTickets.map(ticket => createTicketCard(ticket, false)).join('');
        }

        function createTicketCard(ticket, showStatusControl) {
            const creator = storageService.getUserById(ticket.createdBy);
            const statusOptions = ['assigned', 'in_progress', 'resolved'];
            
            return `
                <div class="ticket-card">
                    <div class="ticket-header">
                        <h4>${ticket.id}</h4>
                        <span class="status-badge status--${ticket.status}">${ticket.status}</span>
                    </div>
                    <div class="ticket-content">
                        <h5>${ticket.subject}</h5>
                        <p>${ticket.description}</p>
                        <div class="ticket-meta">
                            <span class="priority priority--${ticket.priority.toLowerCase()}">${ticket.priority} Priority</span>
                            <span class="date">Created: ${new Date(ticket.createdAt).toLocaleDateString()}</span>
                            <span class="creator">By: ${creator ? creator.username : 'Unknown'}</span>
                        </div>
                        ${showStatusControl ? `
                            <div class="ticket-actions">
                                <label for="status-${ticket.id}" class="form-label">Update Status:</label>
                                <select id="status-${ticket.id}" class="status-select" onchange="updateTicketStatus('${ticket.id}', this.value)">
                                    ${statusOptions.map(status => 
                                        `<option value="${status}" ${ticket.status === status ? 'selected' : ''}>${status}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function updateTicketStatus(ticketId, newStatus) {
            ticketService.updateTicketStatus(ticketId, newStatus);
            uiService.showToast(`Ticket ${ticketId} status updated to ${newStatus}`, 'success');
            loadData();
        }

        function updateStats() {
            const tickets = ticketService.getTicketsForUser(currentUser.id, 'agent');
            document.getElementById('assignedCount').textContent = tickets.filter(t => t.status === 'assigned' || t.status === 'in_progress').length;
            document.getElementById('inProgressCount').textContent = tickets.filter(t => t.status === 'in_progress').length;
            document.getElementById('resolvedCount').textContent = tickets.filter(t => t.status === 'resolved').length;
        }

        function logout() {
            authService.logout();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>